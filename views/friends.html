<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Section</title>
  <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
  <div class="container">
    <h1>User Section</h1>

    <section>
      <h2>All Users</h2>
      <ul id="all-users"></ul>
    </section>

    <section>
      <h2>Friend Requests Sent</h2>
      <ul id="sent-requests"></ul>
    </section>

    <section>
      <h2>Friend Requests Received</h2>
      <ul id="received-requests"></ul>
    </section>

    <section>
      <h2>Your Friends</h2>
      <ul id="friends-list"></ul>
    </section>
  </div>

  <script>
    async function sendRequest(toUserId) {
      const response = await fetch(window.location.origin + '/friend/send-request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to: toUserId })
      });
      const result = await response.json();
      alert(result.message);
      loadAllUsers();
    }

    async function cancelRequest(toUserId) {
      const response = await fetch(window.location.origin + '/friend/cancel-request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to: toUserId })
      });
      const result = await response.json();
      alert(result.message);
      loadAllUsers();
    }

    async function acceptRequest(fromUserId) {
      const response = await fetch(window.location.origin + '/friend/accept-request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ from: fromUserId })
      });
      const result = await response.json();
      alert(result.message);
      loadAllUsers();
    }

    async function rejectRequest(fromUserId) {
      const response = await fetch(window.location.origin + '/friend/reject-request', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ from: fromUserId })
      });
      const result = await response.json();
      alert(result.message);
      loadAllUsers();
    }

    async function loadAllUsers() {
      const res = await fetch(window.location.origin + '/friend/all');
      const data = await res.json();
      const allUsersList = document.getElementById('all-users');
      const sentList = document.getElementById('sent-requests');
      const receivedList = document.getElementById('received-requests');
      const friendsList = document.getElementById('friends-list');

      allUsersList.innerHTML = '';
      sentList.innerHTML = '';
      receivedList.innerHTML = '';
      friendsList.innerHTML = '';

      data.allUsers.forEach(user => {
        const li = document.createElement('li');
        li.textContent = user.username;
        const btn = document.createElement('button');
        btn.textContent = 'Send Friend Request';
        btn.onclick = () => sendRequest(user._id);
        li.appendChild(btn);
        allUsersList.appendChild(li);
      });

      data.sentRequests.forEach(user => {
        const li = document.createElement('li');
        li.textContent = user.username;
        const btn = document.createElement('button');
        btn.textContent = 'Cancel Request';
        btn.onclick = () => cancelRequest(user._id);
        li.appendChild(btn);
        sentList.appendChild(li);
      });

      data.receivedRequests.forEach(user => {
        const li = document.createElement('li');
        li.textContent = user.username;

        const acceptBtn = document.createElement('button');
        acceptBtn.textContent = 'Accept';
        acceptBtn.onclick = () => acceptRequest(user._id);

        const rejectBtn = document.createElement('button');
        rejectBtn.textContent = 'Reject';
        rejectBtn.onclick = () => rejectRequest(user._id);

        li.appendChild(acceptBtn);
        li.appendChild(rejectBtn);
        receivedList.appendChild(li);
      });

      data.friends.forEach(user => {
        const li = document.createElement('li');
        li.textContent = user.username;
        friendsList.appendChild(li);
      });
    }

    window.onload = loadAllUsers;
  </script>
</body>
</html>
